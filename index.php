<?php session_start(); ?>
<?php require_once('includes/connection.php'); ?>
<?php require_once('includes/functions.php'); ?>
<?php 
$email = '';
$msg = '';
  if (isset($_POST['submit'])) {

    $errors = array();

    // check if the username and password has been entered
    if (!isset($_POST['email']) || strlen(trim($_POST['email'])) < 1 ) {
      $errors[] = 'Username is Missing / Invalid';
    }

    if (!isset($_POST['password']) || strlen(trim($_POST['password'])) < 1 ) {
      $errors[] = 'Password is Missing / Invalid';
    }

    // check if there are any errors in the form
    if (empty($errors)) {
      // save username and password into variables
      $email    = mysqli_real_escape_string($connection, $_POST['email']);
      $password   = mysqli_real_escape_string($connection, $_POST['password']);
      $hashed_password = sha1($password);
      // prepare database query
      $query = "SELECT * FROM user WHERE email = '{$email}' AND password = '{$hashed_password}' AND is_deleted=0 LIMIT 1";
      $result_set = mysqli_query($connection, $query);

      $query = "SELECT * FROM user WHERE email = '{$email}' AND password = '{$hashed_password}' AND is_deleted=1 LIMIT 1";
      $result_deleted = mysqli_query($connection, $query);

      if (mysqli_num_rows($result_deleted) == 1) {
      	$msg = '<br><p style="color:red;text-align: center;">This account has been Deleted</p>';
      }

      if ($result_set) {
        // query succesfful

        if (mysqli_num_rows($result_set) == 1) {
          // valid user found
          $user = mysqli_fetch_assoc($result_set);
          $_SESSION['user_id'] = $user['id'];
          $_SESSION['first_name'] = $user['first_name'];
          $_SESSION['user_admin'] = $user['user_or_admin'];
          // updating last login
          $query = "UPDATE user SET last_login = NOW() ";
          $query .= "WHERE id = {$_SESSION['user_id']} LIMIT 1";

          $result_set = mysqli_query($connection, $query);

		  $query = "UPDATE user SET login = 1 WHERE id = {$_SESSION['user_id']} LIMIT 1";
		  $result = mysqli_query($connection, $query);
          // redirect to users.php
          header('Location: home-page');
        } else {
          // user name and password invalid
          $errors[] = 'Invalid Username / Password';
        }
      } else {
        $errors[] = 'Database query failed';
      }
    }
  }
?>
<!DOCTYPE html>
<html lang="en">
<head>
	<title>Alex Lanka Developers - Login Page</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link rel="icon" type="image/png" href="assets/images/favicon.png"/>

	<link rel="stylesheet" type="text/css" href="vendorlog/bootstrap/css/bootstrap.min.css">

	<link rel="stylesheet" type="text/css" href="fonts/font-awesome-4.7.0/css/font-awesome.min.css">

	<link rel="stylesheet" type="text/css" href="fonts/Linearicons-Free-v1.0.0/icon-font.min.css">

	<link rel="stylesheet" type="text/css" href="vendorlog/animate/animate.css">

	<link rel="stylesheet" type="text/css" href="vendorlog/css-hamburgers/hamburgers.min.css">

	<link rel="stylesheet" type="text/css" href="vendorlog/animsition/css/animsition.min.css">

	<link rel="stylesheet" type="text/css" href="vendorlog/select2/select2.min.css">

	<link rel="stylesheet" type="text/css" href="vendorlog/daterangepicker/daterangepicker.css">

	<link rel="stylesheet" type="text/css" href="vendorlog/util.css">
	<link rel="stylesheet" type="text/css" href="vendorlog/main.css">
</head>
<body>
	<div class="limiter">
		<div class="container-login100" style="background-image: url('assets/images/251620.jpg');">
			<div class="wrap-login100 p-t-30 p-b-50">
				<span class="login100-form-title p-b-41">
					<img src="assets/images/logo.png">
				</span>
				<form class="login100-form validate-form p-b-33 p-t-5" action="index.php" method="post">


					<div class="wrap-input100 validate-input" data-validate = "Enter your e-mail">
						<input class="input100" type="text" name="email" value="<?php echo $email;?>" placeholder="Your Email">
						<span class="focus-input100" data-placeholder="&#xe82a;"></span>
					</div>

					<div class="wrap-input100 validate-input" data-validate="Enter password">
						<input class="input100" type="password" name="password" placeholder="Password">
						<span class="focus-input100" data-placeholder="&#xe80f;"></span>
					</div>

					<div class="container-login100-form-btn m-t-32">
						<button class="login100-form-btn" type="submit" name="submit">Login</button>
					</div>
		        <?php 
		          if (isset($errors) && !empty($errors)) {
		            echo '<br><p style="color:red;text-align: center;">Invalid Email OR Password</p>';
		          }
		        ?>
		        <?php 

					if(isset($_GET['log_out']))
					{
						$code=$_GET['log_out'];
						if($code == 1){
							echo '<br><p style="color:red;text-align: center;">Please login to continue</p>';
						}
					}

					if(isset($_GET['log_out']))
					{
						$code=$_GET['log_out'];
						if($code == 2){
							echo '<br><p style="color:red;text-align: center;">Your account has been Deleted</p>';
						}
					}

					if(isset($_GET['log_out']))
					{
						$code=$_GET['log_out'];
						if($code == 3){
							echo '<br><p style="color:green;text-align: center;">You are successful log out</p>';
						}
					}

					if(isset($_GET['log_out']))
					{
						$code=$_GET['log_out'];
						if($code == 4){
							echo '<br><p style="color:green;text-align: center;">Session Timeout</p>';
						}
					}

					if(isset($_GET['log_out']))
					{
						$code=$_GET['log_out'];
						if($code == 5){
							echo '<br><p style="color:red;text-align: center;">You are NOT login</p>';
						}
					}

					echo $msg;
		        ?>

				</form>
			</div>
		</div>
	</div>
		
	<div id="dropDownSelect1"></div>	

	<script src="vendorlog/jquery/jquery-3.2.1.min.js"></script>

	<script src="vendorlog/animsition/js/animsition.min.js"></script>

	<script src="vendorlog/bootstrap/js/popper.js"></script>

	<script src="vendorlog/bootstrap/js/bootstrap.min.js"></script>

	<script src="vendorlog/select2/select2.min.js"></script>

	<script src="vendorlog/daterangepicker/moment.min.js"></script>

	<script src="vendorlog/daterangepicker/daterangepicker.js"></script>

	<script src="vendorlog/countdowntime/countdowntime.js"></script>

	<script src="assets/js/login/main.js"></script>

</body>
</html>

<?php mysqli_close($connection); ?>